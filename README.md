## Certification Extension for firefox: Document

### 1.firefox插件运行机理简介

#### Web Extension API:

从firefox 48开始,为了使浏览器插件的代码更具有通用性,火狐浏览器抛弃原有的基于SDK的插件开发系统,转而使用webExtension API进行插件的开发.

Web Extension 的javascript API 包含了插件被允许对浏览器做的所有操作,比如发送web请求(webRequest),向操作系统发送通知(Notification),浏览器本地存储(Storage)等等.

使用Web Extension 的javascript API ,再基于html/css/javascript,就能够开发firefox插件了.

manifest.js 是插件的全局配置文件,在这个文件中,比较有用的三个配置项是:

- ```
  "permissions": [
      "storage",
      "notifications",
      "webRequestBlocking",
      "webRequest",
      "<all_urls>",
      "activeTab"
    ]
  ```

  这个字段向浏览器用户申请权限,本项目中申请了5个权限:存储\提示\拒绝网络请求\发起网络请求\允许插件弹窗.使用这些权限,我们就可以做到私钥本地加密存储\提示用户当前浏览网站的安全性\在插件中发起网络请求\用户证书注册界面展示等功能.

- ```js
  "content_scripts": [
    {
      "matches": ["://.hitbank.online/","://.172.20.38.160/"],
      "js": ["content_scripts/cryptojs/core.js",
        	 "content_scripts/cryptojs/md5.js",
  			  ....]
    }
  ]
  ```

    这个字段配置的是安全网站的页面加载时应该由插件额外加载进入的javascript脚本文件,通过使用Content Script,我们可以:

  ```
  - 对指定的域名下的网站做安全检查
  ```

  ```
  - 在付款界面通过使用javascript修改html界面元素和发送http请求来实现双签名.
  ```

- ```
  "browser_action": {
      "default_icon": "icons/shield-32.ico",
      "default_title": "SecurityComponent",
      "default_popup": "popup/register.html"
    }
  ```

  这个字段配置了点击插件图标后弹出的popup中使用的html/js/css文件,编辑popup/register.html,就可以像编写普通网页一样来写插件的交互页面了.

#### 插件发布

  firefox发布需要获取firefox的官方签名,由于本实验没有什么实用性质,获取不到签名,因此本项目插件相关的测试都在测试版本中进行.

#### 运行流程

- firefox加载插件
- 加载Browser_action中指定的html/js/css文件.
- 用户访问Content Script的match字段中指定的域名时,向用户获取权限.
- 对该页面注入指定的js代码.
- 执行js代码,验证签名/实现双签名

### 2.功能特性

#### 注册用户证书

- 用户在访问需要安全服务的页面时(在本项目中就是银行和商家域名下的页面),插件会检测用户在当前域名对应的存储空间中是否存储了用户的证书,如果没有证书,则弹窗提示用户注册证书.

  需要说明的是,在firefox插件中使用本地永久存储时,各个域名的存储空间是隔离的,也就是说分属两个域名下的脚本不能访问到对方存储空间中的数据,因此每当用户第一次登录一个需要安全验证的网站时,都要重新注册一个证书;只要注册了一次,之后再访问相同的网站,就不用再注册了.

- 用户注册证书时,需要输入姓名,身份证号,email地址,用户公钥,用户私钥,加密私钥用的密码.

- 点击注册后,插件通过xmlHTTPRequest对象,向CA服务器发送异步证书请求

- 收到CA服务器签名后的证书以及CA服务器本身的证书后,以键值对的形式存储到改域名下的本地存储中.

- 至此,注册完成

#### 网站合法性验证

- 用户访问需要安全服务的页面时,插件会在当前页面的DOM标签中搜索`id="cert"`的标签,从这个标签中获取该网站的证书.

  按照商定,安全网站应该将自己从CA服务器上获取的证书写在`id="cert"`的标签的`value`值中,以便插件获取验证.

- 插件获取网站证书后,从浏览器本地存储中获取CA服务器的证书(CA服务器证书在用户注册成功后被保存到本地存储中),用CA服务器的公钥对网站证书进行验证,如果验证成功,则表示该网站是经过授权的网站;否则弹窗提示该网站证书不正确.

#### 加密存储用户私钥,支付时解密

- 用户注册证书时,需要输入加密存储私钥所需的密码,这个密码被插件用来生成AES对称秘钥
- 注册成功后,插件这个对称秘钥将用户的私钥AES加密存储在本地存储中.
- 支付时,用户必须输入正确的密码才能解出正确的私钥,从而完成付款.

#### 双签名

在购物平台的实现中,付款页面的"付款"按钮是没有填写跳转链接的,这是因为插件需要在这个页面中完成双签名的过程,具体的流程如下:

- 插件监听付款按钮的点击事件,若点击,则显示输入银行卡号的以及用于解密私钥的密码(简称私钥密码)的输入框.
- 若私钥密码输入不正确,则弹窗提示;
- 若输入正确的密码,则插件提取当前页面中的订单信息(OI),计算MD5值,得到订单信息的Hash值(OIHash);获取用户输入的银行卡号和总金额(PI),计算MD5值,得到支付信息的Hash值(PIHash).之后将OIHash和PIHash串联起来,再次计算hash值,得到OPHash,最后用用户的私钥对这个hash值进行签名,得到签名值DoubleSign.
- 接下来要做的是用一个异步Http请求,将OI+PIHah+DoubleSign发给商家,在调函数中,将PI+OIHash+DoubleSign写在一个指向银行登录页面的链接的参数中,将这个链接放置在支付按钮的a标签中的href属性中,之后用js模拟点击事件,跳转到银行登录界面的同时,完成了双签名信息的传递.
- 接着用户只需要在银行界面登录并输入银行卡密码就能够完成付款.

### 3.安全特性

- 用户私钥加密存储(AES 512)
- 支持双签名
- 验证每个网页的证书合法性